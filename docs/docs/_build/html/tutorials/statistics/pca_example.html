<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PCA &#8212; turbustat v1.0.dev2400</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="PDF" href="pdf_example.html" />
    <link rel="prev" title="Modified Velocity Centroids" href="mvc_example.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          turbustat</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0.dev2400</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installing TurbuStat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accepted_input_formats.html">Accepted Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preparing_simulated_data.html">Preparing Simulated Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_requirements.html">Data Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../moments.html">Deriving Cube Moments</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">TurbuStat Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generating_test_data.html">Creating testing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html#distance-metrics">Distance Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to TurbuStat</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">PCA</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#using">Using</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="mvc_example.html" title="Previous Chapter: Modified Velocity Centroids"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Modified Velo...</span>
    </a>
  </li>
  <li>
    <a href="pdf_example.html" title="Next Chapter: PDF"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">PDF &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../../_sources/tutorials/statistics/pca_example.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">PCA</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#using">Using</a></li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="pca">
<span id="pca-tutorial"></span><h1>PCA<a class="headerlink" href="#pca" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Principal Component Analysis (PCA) is primarily a dimensionality reduction technique. Generally the data are arranged into a set of columns (representing dimensions or variables) and the set of samples is contained within each row. A covariance matrix is then constructed between each pair of columns. Performing an eigenvalue decomposition of this matrix gives an orthogonal basis for the data, the components of which are the principal components (eigenvectors). The associated eigenvalues correspond to the variance in the data described by each principal component.</p>
<p>By ordering the principal components from the largest to smallest eigenvalue, a minimal set of eigenvectors can be found that account for a large portion of the variance within the data. These first N principal components have a (usually) much reduced dimensionality, while still containing the majority of the structure in the data. The <a class="reference external" href="https://en.wikipedia.org/wiki/Principal_component_analysis">PCA Wikipedia</a> page has a much more thorough explanation.</p>
<p>The use of PCA on spectral-line data cubes was introduced by <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/1997ApJ...475..173H/abstract">Heyer &amp; Schloerb 1997</a>, and thoroughly extended in a number of other papers (e.g., <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..276B/abstract">Brunt &amp; Heyer 2002a</a>, <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..289B/abstract">Brunt &amp; Heyer 2002b</a>, <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2011ApJ...740..120R/abstract">Roman-Duval et al. 2011</a>). An analytical derivation is given in <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2013MNRAS.433..117B/abstract">Brunt &amp; Heyer 2013</a>. Briefly, they use the PCA decomposition to measure the associated spectral and spatial width scales associated with each principal component. An eigenvalue can be multiplied by each spectral channel to produce an eigenimage. The autocorrelation function of that eigenimage gives an estimate of the spatial scale of that principal component. The autocorrelation of the eigenvector itself gives an associated spectral width. Using the spatial and spectral widths from the first N principal components give an estimate of the size-line width relation.</p>
</div>
<div class="section" id="using">
<h2>Using<a class="headerlink" href="#using" title="Permalink to this headline">¶</a></h2>
<p><strong>The data in this tutorial are available</strong> <a class="reference external" href="https://girder.hub.yt/#user/57b31aee7b6f080001528c6d/folder/59721a30cc387500017dbe37">here</a>.</p>
<p>We need to import the PCA code, along with a few other common packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">turbustat.statistics</span> <span class="k">import</span> <span class="n">PCA</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<p>And we load in the data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;Design4_flatrho_0021_00_radmc.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA" title="turbustat.statistics.PCA"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PCA</span></code></a> class is first initialized, and the distance to the region (if desired) can be given:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mf">250.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p>If the distance is given, you will have the option to convert spatial widths to physical units. <em>Note that we’re using simulated data and the distance of 250 pc has no special meaning in this case.</em> If no distance is provided, conversions to the physical units will return an error.</p>
<p>The simplest way to run the entire process is using the <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.run" title="turbustat.statistics.PCA.run"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code></a> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">spatial_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">spectral_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">brunt_beamcorrect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">Proportion of Variance kept: 0.999693451344</span>
<span class="go">Index: 0.64 (0.62, 0.66)</span>
<span class="go">Gamma: 0.55 (0.51, 0.59)</span>
<span class="go">Sonic length: 1.449e-01 (1.360e-01, 1.538e-01) pc at 10.0 K</span>
</pre></div>
</div>
<img alt="../../_images/pca_design4_default.png" src="../../_images/pca_design4_default.png" />
<p>Note that we have specified the output units for the spectral and spatial units. By default, these would be kept in pixel units.
The key properties are shown when <code class="xref py py-obj docutils literal notranslate"><span class="pre">verbose=True</span></code>: a summary of the results with a plot of the covariance matrix (top left), the variance described by the principal components (bottom left) and the size-line width relation (right). The proportion of variance is the variance contained in the N eigenvalues kept. In this case, we consider all eigenvalues with values above 1e-4 to be important. In observational data, <code class="xref py py-obj docutils literal notranslate"><span class="pre">min_eigval</span></code> should be set to the variance of the noise (square of the rms uncertainty).  Typically, only the first <span class="math notranslate nohighlight">\(\sim10\)</span> eigenvalues contain signal in observational data.</p>
<p>In the output above <code class="xref py py-obj docutils literal notranslate"><span class="pre">index</span></code> is the slope of the size-line width relation, and <code class="xref py py-obj docutils literal notranslate"><span class="pre">gamma</span></code> is the the slope with a correction factor applied (see <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.gamma" title="turbustat.statistics.PCA.gamma"><code class="xref py py-obj docutils literal notranslate"><span class="pre">gamma</span></code></a>). The sonic length is derived from the intercept of the size-line width relation using a default temperature of 10 K (see below on how to change this).</p>
<p>Since these data are simulated, this example does not account for a finite beam size. If it did, however, we would want to deconvolve the spatial widths with the beam. To see this effect, let us assume these data have a 20” circular beam:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">spatial_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">spectral_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">brunt_beamcorrect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">beam_fwhm</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">Proportion of Variance kept: 0.999693451344</span>
<span class="go">Index: 0.54 (0.51, 0.57)</span>
<span class="go">Gamma: 0.37 (0.33, 0.42)</span>
<span class="go">Sonic length: 8.739e-02 (7.589e-02, 9.888e-01) pc at 10.0 K</span>
</pre></div>
</div>
<img alt="../../_images/pca_design4_beamcorr.png" src="../../_images/pca_design4_beamcorr.png" />
<p>Since the correction is not linear, the slope changes with the beam correction. If the header of the data has the beam information defined, it will be automatically read in and <code class="xref py py-obj docutils literal notranslate"><span class="pre">beam_fwhm</span></code> will not have to be given.</p>
<p>Both of the PCA runs above do <em>not</em> subtract the mean of the data before creating the covariance matrix. Technically, this is not how PCA is defined (see Overview above) and the decomposition is not performed on a true covariance matrix. The justification used in <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..276B/abstract">Brunt &amp; Heyer 2002a</a> and <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..289B/abstract">Brunt &amp; Heyer 2002b</a> is that the mean has a physical meaning in this case: it’s the largest spatial scale across the map. If we <em>do</em> subtract the mean, how does this affect the index?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">spatial_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">spectral_output_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">brunt_beamcorrect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">beam_fwhm</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">mean_sub</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">Proportion of Variance kept: 0.999808532503</span>
<span class="go">Index: 0.70 (0.67, 0.74)</span>
<span class="go">Gamma: 0.63 (0.59, 0.66)</span>
<span class="go">Sonic length: 1.004e-01 (9.384e-02, 1.070e-01) pc at 10.0 K</span>
</pre></div>
</div>
<img alt="../../_images/pca_design4_beamcorr.png" src="../../_images/pca_design4_beamcorr.png" />
<p>The plot shows how the structure of the covariance matrix has changed. There remains a central peak, though it is smaller, and the positive structure around it is more elongated. The bar plot shows that the relative values of the eigenvalues have changed significantly; this intuitively makes sense as the covariance structure was changed. The index measured is significantly higher than the <code class="xref py py-obj docutils literal notranslate"><span class="pre">0.56</span></code> measured above. If we compare the points on the size-line width relation, we see that the steeper relation results from the spectral width remaining the same as in the the non-mean subtracted case, while the spatial size is decreased.</p>
<p>The default setting is to <em>not</em> subtract the mean in order to best reproduce the established Brunt &amp; Heyer formalism. This comparison is included to demonstrate its effect and to highlight that, in not subtracting the mean, some of the assumptions used in PCA are violated. See the <a class="reference external" href="https://en.wikipedia.org/wiki/Principal_component_analysis">PCA Wikipedia</a> page for more information.</p>
<p>The <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.run" title="turbustat.statistics.PCA.run"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code></a> command has several steps hidden within it. To demonstrate the whole process, the individual steps are broken down below. There are 4 major steps: decomposition, spatial fitting, spectral fitting, and fitting of the size-line width relation.</p>
<p>First, the eigenvalue decomposition is performed using <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.compute_pca" title="turbustat.statistics.PCA.compute_pca"><code class="xref py py-obj docutils literal notranslate"><span class="pre">compute_pca</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">compute_pca</span><span class="p">(</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_eigs</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">eigen_cut_method</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">n_eigs</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">10</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">mean_sub</span></code> controls whether to subtract the channel means when calculating the covariance matrix. Formally, this is implied when calculating any covariance matrix, but is not done in the Brunt &amp; Heyer works (see above). <code class="xref py py-obj docutils literal notranslate"><span class="pre">n_eigs</span></code> sets the number of important principal components (which will be used to fit the size-line width relation). This can be an integer, or the code will determine the number of important components based off of a threshold given in <code class="xref py py-obj docutils literal notranslate"><span class="pre">min_eigval</span></code>. When <code class="xref py py-obj docutils literal notranslate"><span class="pre">eigen_cut_method='value'</span></code>, <code class="xref py py-obj docutils literal notranslate"><span class="pre">min_eigval</span></code> is the smallest eigenvalue to consider important. Since the variance is related to the level of variance due to noise in the data, it is practical to set this to a few times the noise variance. When <code class="xref py py-obj docutils literal notranslate"><span class="pre">eigen_cut_method='proportion'</span></code>, <code class="xref py py-obj docutils literal notranslate"><span class="pre">min_eigval</span></code> now corresponds to the total proportion of variance that is considered important:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">compute_pca</span><span class="p">(</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_eigs</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">eigen_cut_method</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">n_eigs</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">4</span>
</pre></div>
</div>
<p>This will keep the number of components that describe 99% of the variance in the data. The percentage of variance described by a principal component is its eigenvalue divided by the sum of all eigenvalues (the total variance in the data). All other components beyond these levels are due to irreducible noise. These noise components can be thought of as an N-dimensional sphere, where it becomes impossible to diminish the remaining variance as there is no preferred direction.</p>
<p>The eigenvalues of the important components can be generated with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">eigvals</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p>This will return the full set of eigenvalues as a two-dimensional array with a shape equal to the number of spectral channels in the data. To only return the important eigenvalues, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">eigvals</span><span class="p">[:,</span> <span class="p">:</span><span class="n">pca</span><span class="o">.</span><span class="n">n_eigs</span><span class="p">]</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p>Eigenimages have the same shape as the spatial dimensions of the data. To save memory, eigenimages are not cached and are calculated from the data and set of eigenvalues:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">eigimgs</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">eigimages</span><span class="p">()</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">eigimgs</span></code> is a three-dimensional array, with two spatial axes and the third the number of eigenimages requested. By default, the number of eigenimages returned is equal to <code class="xref py py-obj docutils literal notranslate"><span class="pre">pca.n_eigs</span></code>. To instead return the first <code class="xref py py-obj docutils literal notranslate"><span class="pre">n</span></code> eigenimages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="mi">40</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">eigimgs</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">eigimages</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<p>The second step is to calculate the spatial size scales from the autocorrelation of the eigenimages (reverting back to the PCs from <code class="xref py py-obj docutils literal notranslate"><span class="pre">eigen_cut_method='value'</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">compute_pca</span><span class="p">(</span><span class="n">mean_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_eigs</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">min_eigval</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
<span class="gp">... </span>                <span class="n">eigen_cut_method</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">find_spatial_widths</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="n">beam_fwhm</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">brunt_beamcorrect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">diagnosticplots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<img alt="../../_images/pca_autocorrimgs_contourfit_Design4.png" src="../../_images/pca_autocorrimgs_contourfit_Design4.png" />
<p>This will find the spatial widths by fitting an ellipse to the 1/e contour about the peak in the autocorrelation image, following the fitting technique described by Brunt &amp; Heyer. The first 9 autocorrelation images are shown in the above image, where the cyan contours are the true 1/e contour, and the green dashed line is the elliptical fit. Note that the first autocorrelation image is not shown. This is because the fitting routine failed; if the 1/e level is not reached in the data, there is no contour to fit to. This means that the largest spatial scale in the data (which critically depends on the mean) is <em>larger</em> than the spatial size of the data. For a periodic-box simulation, which this example data is produced from, it is not surprising that this has occurred. <strong>Note: If this issue is encountered in observational data (or anything without periodic boundaries), try padding the data cube in the spatial directions with zeros to simulate a larger map size.</strong></p>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">method</span></code> may also be set to <code class="xref py py-obj docutils literal notranslate"><span class="pre">fit</span></code> to fit a 2D Gaussian to the peak, <code class="xref py py-obj docutils literal notranslate"><span class="pre">interpolate</span></code> which estimates the 1/e from the peak using a fine grid about the peak region, and <code class="xref py py-obj docutils literal notranslate"><span class="pre">xinterpolate</span></code> which first fits a 2D Gaussian to better determine the fine grid to use in interpolation. The default method is <code class="xref py py-obj docutils literal notranslate"><span class="pre">contour</span></code>.</p>
<p>When beam correction is applied (<code class="xref py py-obj docutils literal notranslate"><span class="pre">brunt_beamcorrect</span></code>), the angular FWHM of the beam is needed. This is to deconvolve the spatial widths with the beam size. Note that all spatial scales that cannot be deconvolved from the beam will be set to <code class="xref py py-obj docutils literal notranslate"><span class="pre">NaN</span></code>. If the <code class="xref py py-obj docutils literal notranslate"><span class="pre">BMAJ</span></code> keyword is set in the FITS header in <code class="xref py py-obj docutils literal notranslate"><span class="pre">cube</span></code>, this will be read automatically (also if the <a class="reference external" href="https://github.com/radio-astro-tools/radio_beam">radio_beam</a> package is installed, a few other keywords will be recognized). Otherwise, this must be specified in <code class="xref py py-obj docutils literal notranslate"><span class="pre">beam_fwhm</span></code>. If the data do not have a beam size, <code class="xref py py-obj docutils literal notranslate"><span class="pre">brunt_beamcorrect=False</span></code> will need to be specified in <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.find_spatial_widths" title="turbustat.statistics.PCA.find_spatial_widths"><code class="xref py py-obj docutils literal notranslate"><span class="pre">find_spatial_widths</span></code></a> and <a class="reference internal" href="../../api/turbustat.statistics.PCA.html#turbustat.statistics.PCA.run" title="turbustat.statistics.PCA.run"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run</span></code></a>.</p>
<p>Third, we find the spectral widths:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">find_spectral_widths</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;walk-down&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">autocorr_spec</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">autocorr_spec</span><span class="p">()</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">autocorr_spec</span><span class="p">[:</span><span class="mi">251</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;exp(-1)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">spectral_width</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="gp">... </span>               <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted Width&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># doctest: +SKIP</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<img alt="../../_images/pca_autocorrspec_Design4.png" src="../../_images/pca_autocorrspec_Design4.png" />
<p>The above image shows the 50 components of the first 9 autocorrelation spectra (the data cube has 500 channels in total, but this is the region of interest). The local minima referred to in the next paragraph are the first minimum points in each of the spectra.</p>
<p>There are three methods available to estimate spectral widths of the autocorrelation spectra. <code class="xref py py-obj docutils literal notranslate"><span class="pre">walk-down</span></code> starts from the peak and continues until the 1/e level is reached. The width is estimated by averaging the points before and after this level is reached. This is the method used by Brunt &amp; Heyer. Otherwise, <code class="xref py py-obj docutils literal notranslate"><span class="pre">method</span></code> may be set to <code class="xref py py-obj docutils literal notranslate"><span class="pre">fit</span></code>, which fits a Gaussian to the data before the first local minimum occurs, and <code class="xref py py-obj docutils literal notranslate"><span class="pre">interpolate</span></code>, which does the same, but through interpolating onto a finer grid. As shown in the above figure, the number of oscillations in the autocorrelation spectrum increases with the Nth principal component. The width of interest is determined from the first peak to the first minimum.</p>
<p><strong>Note: If your input data have few spectral channels, it may be necessary to pad additional channels of zeros onto the data. Otherwise the 1/e level may not be reached. This should not have a significant effect on the results, as the added eigenvalues of these channels will be zero and should not be considered.</strong></p>
<p>Finally, we fit the size-line width relation. There is no clear independent variable to fit, and significant errors in both dimensions which must be taken into account. This is the <em>error-in-variables problem</em>, and an excellent explanation is provided in <a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2010arXiv1008.4686H/abstract">Hogg, Bovy &amp; Lang 2010</a>. The Brunt &amp; Heyer works have used the bisector method. In TurbuStat, two fitting methods are available: <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/odr.html">Orthogonal Distance Regression (ODR)</a>, and a Markov Chain Monte Carlo (MCMC) method. Practically both methods are doing the same thing, but the MCMC provides a direct sampling (assuming uniform priors). The MCMC method requires the <a class="reference external" href="http://dan.iel.fm/emcee/current/">emcee</a> package to be installed.</p>
<p>To run ODR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">fit_plaw</span><span class="p">(</span><span class="n">fit_method</span><span class="o">=</span><span class="s1">&#39;odr&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<img alt="../../_images/pca_design4_plaw_odr.png" src="../../_images/pca_design4_plaw_odr.png" />
<p>And to run the MCMC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">fit_plaw</span><span class="p">(</span><span class="n">fit_method</span><span class="o">=</span><span class="s1">&#39;bayes&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
</pre></div>
</div>
<img alt="../../_images/pca_design4_plaw_mcmc.png" src="../../_images/pca_design4_plaw_mcmc.png" />
<p>Additional arguments for setting the chain properties can be passed as well. See documentation for <code class="xref py py-obj docutils literal notranslate"><span class="pre">bayes_linear</span></code>. The verbose mode shows the fit results along with the data points.</p>
<p>The interesting outputs from this analysis are estimates of the slopes of the size-line width relation (<span class="math notranslate nohighlight">\(\gamma\)</span>) and the sonic length:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">gamma</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">0.433</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pca</span><span class="o">.</span><span class="n">sonic_length</span><span class="p">(</span><span class="n">T_k</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">1.36</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>  <span class="c1"># doctest: +SKIP</span>
<span class="go">(&lt;Quantity 0.35451525 pc&gt;, &lt;Quantity [0.27522952, 0.45267135] pc&gt;)</span>
</pre></div>
</div>
<p>Sonic length is defined as the length at which the fitted line intersects the sounds speed (temperature can be specified with <code class="xref py py-obj docutils literal notranslate"><span class="pre">T_k</span></code> above).  Since the sonic length depends on temperature and <span class="math notranslate nohighlight">\(\mu\)</span>, this is a function and not a property like <span class="math notranslate nohighlight">\(\gamma\)</span>. <code class="xref py py-obj docutils literal notranslate"><span class="pre">PCA.sonic_length</span></code> also returns the 1-sigma error bounds. The error bounds in <span class="math notranslate nohighlight">\(\gamma\)</span> can be accessed with <code class="xref py py-obj docutils literal notranslate"><span class="pre">PCA.gamma_error_range</span></code>.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/1997ApJ...475..173H/abstract">Heyer &amp; Schloerb 1997</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2013MNRAS.433..117B/abstract">Brunt &amp; Heyer 2013</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..276B/abstract">Brunt &amp; Heyer 2002a</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2002ApJ...566..289B/abstract">Brunt &amp; Heyer 2002b</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2008ApJ...680..420H/abstract">Heyer et al. 2008</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2010arXiv1008.4686H/abstract">Hogg, Bovy &amp; Lang 2010</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2011ApJ...740..120R/abstract">Roman-Duval et al. 2011</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2014MNRAS.440..465B/abstract">Bertram et al. 2014</a></p>
<p><a class="reference external" href="https://ui.adsabs.harvard.edu/#abs/2016ApJ...818..118C/abstract">Correia et al. 2016</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, TurbuStat Development Team.<br/>
      Last updated on 13 Feb 2019.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>